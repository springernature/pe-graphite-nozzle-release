set -e -x

cp /var/vcap/packages/git/bin/git /usr/bin/git

echo "Extracting graphite-nozzle package..."
tar xvf graphite-nozzle/graphite-nozzle-125839f.tar.gz

mkdir -p gowork/src/github.com/pivotal-cf
mv graphite-nozzle-125839f gowork/src/github.com/pivotal-cf/graphite-nozzle

echo "Setting the GO env variables..."

export GOPATH=${BOSH_COMPILE_TARGET}/gowork
export GOROOT=$(readlink -nf /var/vcap/packages/golang1.6)
export PATH=${GOROOT}/bin:${GOPATH}/bin:${PATH}

echo "Installing graphite-nozzle..."

go get github.com/tools/godep

pushd $GOPATH/src/github.com/pivotal-cf/graphite-nozzle
  godep restore
  godep go install
  mkdir -p ${BOSH_INSTALL_TARGET}/bin
  install -m 0755 $GOPATH/bin/graphite-nozzle ${BOSH_INSTALL_TARGET}/bin
popd